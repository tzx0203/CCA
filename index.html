<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Patient Allocation</title>
<style>
  :root {
    /* Light Theme Variables */
    --bg-body: #f3f4f6;
    --bg-card: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    
    --accent-color: #3b82f6; /* Blue */
    --accent-hover: #2563eb;
    
    --success-color: #10b981; /* Green for Recalc */
    --success-hover: #059669;
    
    --border-color: #e5e7eb;
    --input-bg: #f9fafb;
    
    /* Table Specifics */
    --table-bg: #ffffff;
    --table-head-bg: #f8fafc;
    --table-border: #e2e8f0;
    --table-hover: #f1f5f9;
    
    /* Lock Colors */
    --lock-active: #ef4444;   /* Red when locked */
    --lock-inactive: #94a3b8; /* Grey when unlocked */
    
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  [data-theme="dark"] {
    /* Dark Theme Variables */
    --bg-body: #0f172a;
    --bg-card: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    
    --accent-color: #60a5fa;
    --accent-hover: #3b82f6;
    
    --success-color: #34d399;
    --success-hover: #10b981;
    
    --border-color: #334155;
    --input-bg: #0f172a;
    
    --table-bg: #1e293b;
    --table-head-bg: #0f172a;
    --table-border: #334155;
    --table-hover: #334155;
    
    /* Lock Colors - Pure White for Dark Mode Visibility */
    --lock-active: #f87171;
    --lock-inactive: #ffffff; 
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    margin: 0;
    padding: 24px;
    background-color: var(--bg-body);
    color: var(--text-primary);
    transition: background-color 0.3s ease, color 0.3s ease;
    line-height: 1.5;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* --- Header --- */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
  }

  h2 { margin: 0; font-size: 1.75rem; font-weight: 800; letter-spacing: -0.025em; }

  .theme-toggle {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: 9999px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
  }
  .theme-toggle:hover { background-color: var(--table-hover); }

  /* --- Card & Layout --- */
  .card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 32px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
  }

  .dashboard-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    align-items: stretch;
  }

  /* --- Inputs Section --- */
  .input-section { display: flex; flex-direction: column; gap: 24px; }

  .config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: 16px;
  }

  .input-group { display: flex; flex-direction: column; gap: 8px; }
  .input-group label {
    font-size: 0.75rem; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.05em;
  }

  input[type=number] {
    padding: 12px;
    font-size: 1.1rem;
    font-family: inherit;
    font-weight: 500;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 10px;
    width: 100%;
    transition: all 0.2s;
  }
  input[type=number]:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  /* --- Buttons --- */
  .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-top: auto; }

  button.action-btn {
    padding: 14px 24px; 
    border-radius: 10px; 
    font-weight: 600; 
    font-size: 0.95rem;
    cursor: pointer; 
    transition: transform 0.1s, background-color 0.2s, color 0.2s; 
    flex: 1;
    border: none;
    color: white; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  button.action-btn:active { transform: translateY(1px); }

  /* Primary (Blue) */
  .btn-primary { background: var(--accent-color); }
  .btn-primary:hover { background: var(--accent-hover); }

  /* Success (Green) */
  .btn-success { background: var(--success-color); color: #fff; }
  [data-theme="dark"] .btn-success { color: #0f172a; }
  .btn-success:hover { background: var(--success-hover); }

  /* Secondary (Outline) */
  button.secondary-btn {
    background: transparent; 
    color: var(--text-primary);
    border: 1px solid var(--border-color); 
    padding: 14px 24px;
    border-radius: 10px; 
    font-weight: 600; 
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: none;
  }
  button.secondary-btn:hover { background: var(--table-hover); border-color: var(--text-secondary); }
  [data-theme="dark"] button.secondary-btn { border-color: #475569; }

  /* --- Result Scoreboard --- */
  .result-section {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 32px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    position: relative;
  }
  
  .result-label {
    font-size: 0.8rem; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 16px;
  }

  #finalPrev {
    font-size: 4rem; font-weight: 800; color: var(--text-primary);
    line-height: 1; letter-spacing: -0.03em;
  }

  #finalAfter {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 1.1rem; margin-top: 16px; color: var(--text-secondary);
    background: rgba(0,0,0,0.05); padding: 4px 12px; border-radius: 6px;
  }
  [data-theme="dark"] #finalAfter { background: rgba(255,255,255,0.05); }

  .stat-display { font-size: 0.9rem; font-weight: 600; color: var(--accent-color); margin-top: 8px; }

  /* --- MODERN TABLE STYLES --- */
  .table-wrapper {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-md);
    background: var(--table-bg);
  }

  table {
    width: 100%;
    border-collapse: separate; 
    border-spacing: 0;
    min-width: 800px;
  }

  th, td {
    padding: 12px;
    text-align: center;
    border-bottom: 1px solid var(--table-border);
    position: relative;
  }

  /* Table Header */
  thead th {
    background: var(--table-head-bg);
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 700;
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 2px solid var(--table-border);
  }

  /* Staff Column Header Styling */
  .staff-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 99px;
    color: #1f2937;
    font-weight: 700;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    min-width: 70px;
    white-space: nowrap;
  }

  /* Lock Row Specifics */
  .lock-row th {
    background: var(--bg-card);
    padding: 8px;
    border-bottom: 1px solid var(--table-border);
  }

  .lock-btn {
    background: transparent;
    border: 1px solid transparent;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    width: 36px; height: 36px;
  }
  
  /* Hover state for lock button */
  .lock-btn:hover { background: var(--table-hover); border-color: var(--border-color); }
  [data-theme="dark"] .lock-btn:hover { background: rgba(255,255,255,0.1); }
  
  .lock-icon { 
    width: 20px; 
    height: 20px; 
    stroke: var(--lock-inactive);
    stroke-width: 2.5; 
    transition: all 0.3s; 
  }
  
  .locked .lock-icon { stroke: var(--lock-active); fill: rgba(239, 68, 68, 0.1); }
  .locked { background: rgba(239, 68, 68, 0.05); border-color: rgba(239, 68, 68, 0.2); }

  /* First Column (Departments) - Sticky */
  tbody th, thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 20;
    background: var(--bg-card);
    border-right: 1px solid var(--table-border);
    text-align: left;
    padding-left: 24px;
    box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05);
  }
  [data-theme="dark"] tbody th { box-shadow: 2px 0 5px -2px rgba(0,0,0,0.3); }

  tbody th { font-weight: 700; color: var(--text-primary); font-size: 0.9rem; }

  /* Table Body Inputs */
  .cell-input {
    width: 100%;
    max-width: 80px;
    border: 1px solid transparent;
    background: transparent;
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    color: var(--text-primary);
    padding: 6px 4px;
    border-radius: 8px;
    cursor: text;
    transition: all 0.2s;
  }

  .cell-input:hover { box-shadow: inset 0 0 0 1px var(--border-color); }
  .cell-input:focus { outline: none; background: var(--bg-card) !important; box-shadow: 0 0 0 2px var(--accent-color); }
  
  .highlighted-cell {
    color: #111827 !important; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  /* Row Totals Column */
  .row-total-cell {
    font-weight: 800;
    color: var(--text-primary);
    background: var(--table-head-bg);
    border-left: 2px solid var(--table-border);
  }

  /* Totals Row (Footer) */
  .row-totals th, .row-totals td {
    background: var(--bg-body) !important;
    border-top: 2px solid var(--border-color);
    font-weight: 800;
    color: var(--text-primary);
  }

  /* Responsive Mobile */
  @media (max-width: 900px) {
    .dashboard-split { grid-template-columns: 1fr; gap: 24px; }
    #finalPrev { font-size: 3rem; }
    .card { padding: 20px; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h2>Patient Allocation</h2>
    <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
  </header>

  <div class="card">
    <div class="dashboard-split">
      
      <!-- Inputs -->
      <div class="input-section">
        <div class="config-grid">
          <div class="input-group">
            <label for="totalStaff">Total Staff</label>
            <input id="totalStaff" type="number" min="1" placeholder="0">
          </div>
          <div class="input-group">
            <label for="icuPatients">ICU</label>
            <input id="icuPatients" type="number" min="0" placeholder="0" oninput="updateTotalPatients()">
          </div>
          <div class="input-group">
            <label for="ctPatients">CT</label>
            <input id="ctPatients" type="number" min="0" placeholder="0" oninput="updateTotalPatients()">
          </div>
          <div class="input-group">
            <label for="cdPatients">CD</label>
            <input id="cdPatients" type="number" min="0" placeholder="0" oninput="updateTotalPatients()">
          </div>
          <div class="input-group">
            <label for="ccuPatients">CCU</label>
            <input id="ccuPatients" type="number" min="0" placeholder="0" oninput="updateTotalPatients()">
          </div>
        </div>
        
        <div id="totalPatientsDisplay" class="stat-display">Total Patients: 0</div>

        <div class="btn-group">
          <button class="action-btn btn-primary" id="calcBtn" onclick="initialCalculate()">Calculate Allocation</button>
          <button class="action-btn btn-success" id="recalcBtn" onclick="recalculateUnlocked()" style="display:none">Recalculate Locked</button>
          <button class="secondary-btn" onclick="resetAll()">Reset</button>
        </div>
      </div>

      <!-- Result Scoreboard -->
      <div class="result-section">
        <div class="result-label">Target Distribution</div>
        <div id="finalPrev">‚Äî</div>
        <div id="finalAfter"></div>
      </div>

    </div>
  </div>

  <!-- Table Card -->
  <div class="card" id="resultsCard" style="display:none; padding: 0; overflow: hidden; border: none; box-shadow: none; background: transparent;">
    <div class="table-wrapper">
      <table id="allocTable" aria-label="Allocation table">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Icons -->
<svg style="display:none">
  <symbol id="icon-unlock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
  </symbol>
  <symbol id="icon-lock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
    <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
  </symbol>
</svg>

<script>
/* ---------- theme management ---------- */
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  
  const themeButton = document.querySelector('.theme-toggle');
  themeButton.textContent = newTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
  localStorage.setItem('theme', newTheme);
}

function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  } else {
    document.documentElement.setAttribute('data-theme', 'light');
  }
  const currentTheme = document.documentElement.getAttribute('data-theme');
  document.querySelector('.theme-toggle').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
}
document.addEventListener('DOMContentLoaded', initTheme);

/* ---------- utilities ---------- */
function toInt(v){ const n = parseInt(v); return isNaN(n)?0:n; }
function inputVal(id){ return toInt(document.getElementById(id).value); }
function setText(id, text){ document.getElementById(id).innerText = text; }

/* ---------- state ---------- */
// 40 Distinct Pastel/Vibrant Tones for Staff Columns
let colors = [
  "#fca5a5", // Red
  "#fdba74", // Orange
  "#fcd34d", // Amber
  "#fde047", // Yellow
  "#bef264", // Lime
  "#86efac", // Green
  "#6ee7b7", // Emerald
  "#5eead4", // Teal
  "#67e8f9", // Cyan
  "#7dd3fc", // Sky
  "#93c5fd", // Blue
  "#a5b4fc", // Indigo
  "#c4b5fd", // Violet
  "#d8b4fe", // Purple
  "#f0abfc", // Fuchsia
  "#f9a8d4", // Pink
  "#fda4af", // Rose
  "#cbd5e1", // Slate
  "#fef08a", // Yellow-Light
  "#bbf7d0", // Green-Light
  "#bfdbfe", // Blue-Light
  "#ddd6fe", // Violet-Light
  "#fecaca", // Red-Light
  "#fed7aa", // Orange-Light
  "#e9d5ff", // Purple-Light
  "#99f6e4", // Teal-Light
  "#fbcfe8", // Pink-Light
  "#bae6fd", // Sky-Light
  "#a7f3d0", // Emerald-Light
  "#c7d2fe", // Indigo-Light
  "#fecdd3", // Rose-Light
  "#ffedd5", // Orange-Pale
  "#e0e7ff", // Indigo-Pale
  "#fae8ff", // Fuchsia-Pale
  "#ffe4e6", // Rose-Pale
  "#ccfbf1", // Teal-Pale
  "#f3f4f6", // Gray-Light
  "#e2e8f0", // Slate-Light
  "#ffcc80", // Orange-Peel
  "#bcaaa4"  // Brown-Pastel
];

let currentData = null; 
let locked = [];       
let staffCount = 0;

/* ---------- live input total ---------- */
function updateTotalPatients(){
  const total = inputVal("icuPatients") + inputVal("ctPatients") + inputVal("cdPatients") + inputVal("ccuPatients");
  setText("totalPatientsDisplay","Total Patients: " + total);
}
updateTotalPatients();

/* ---------- initial calculate ---------- */
function initialCalculate(){
  staffCount = Math.max(1, inputVal("totalStaff"));
  const icu = inputVal("icuPatients");
  const ct  = inputVal("ctPatients");
  const cd  = inputVal("cdPatients");
  const ccu = inputVal("ccuPatients");

  const totalPatients = icu + ct + cd + ccu;
  if (staffCount <= 0) { alert("Please enter valid total staff."); return; }
  if (totalPatients === 0) { alert("Total patients is zero ‚Äî nothing to allocate."); return; }

  document.getElementById("resultsCard").style.display = "block";

  const modResult = totalPatients % staffCount;
  const higher = Math.ceil(totalPatients / staffCount);
  const lower  = Math.floor(totalPatients / staffCount);

  let rem = { CCU: ccu, CD: cd, CT: ct, ICU: icu };
  const CCU = [], CD = [], CT = [], ICU = [], Total = [];
  
  for (let i=1;i<=staffCount;i++){
    const workload = (i <= modResult) ? higher : lower;
    
    const ccuAlloc = Math.min(rem.CCU, workload);
    rem.CCU -= ccuAlloc;

    const cdAlloc = Math.min(rem.CD, workload - ccuAlloc);
    rem.CD -= cdAlloc;

    const ctAlloc = Math.min(rem.CT, workload - ccuAlloc - cdAlloc);
    rem.CT -= ctAlloc;

    const icuAlloc = Math.min(rem.ICU, workload - ccuAlloc - cdAlloc - ctAlloc);
    rem.ICU -= icuAlloc;

    CCU.push(ccuAlloc); CD.push(cdAlloc); CT.push(ctAlloc); ICU.push(icuAlloc);
    Total.push(ccuAlloc+cdAlloc+ctAlloc+icuAlloc);
  }

  currentData = {CCU,CD,CT,ICU,Total};
  locked = new Array(staffCount).fill(false);
  renderTable();
  renderFinalOriginal(currentData);
  document.getElementById("recalcBtn").style.display = "none";
}

/* ---------- render table ---------- */
function renderTable(){
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  thead.innerHTML = ""; tbody.innerHTML = "";

  // 1. Lock Row
  let lockRow = "<tr class='lock-row'><th>Lock</th>";
  for (let i=0;i<staffCount;i++){
    const cls = locked[i] ? "locked" : "";
    lockRow += `<th>
      <button class="lock-btn ${cls}" data-index="${i}" onclick="toggleLock(event,this,${i})" title="Lock Staff ${i+1}">
         <svg class="lock-icon"><use href="#icon-unlock"></use></svg>
      </button>
    </th>`;
  }
  lockRow += "<th></th></tr>";

  // 2. Main Header
  let header = "<tr><th>Dept</th>";
  for (let i=0;i<staffCount;i++){
    const colColor = colors[i % colors.length];
    header += `<th><span class="staff-badge" style="background:${colColor}">Staff ${i+1}</span></th>`;
  }
  header += "<th style='color:var(--text-primary)'>Row Total</th></tr>";

  thead.innerHTML = lockRow + header;

  // 3. Data Rows
  const displayOrder = ["ICU","CT","CD","CCU"];
  displayOrder.forEach((dept)=>{
    let row = `<tr><th>${dept}</th>`;
    let rowTotal = 0;
    
    for (let i=0;i<staffCount;i++){
      let val = 0;
      if (currentData) {
        if (dept === "ICU") val = currentData.ICU[i] || 0;
        if (dept === "CT")  val = currentData.CT[i]  || 0;
        if (dept === "CD")  val = currentData.CD[i]  || 0;
        if (dept === "CCU") val = currentData.CCU[i] || 0;
      }
      rowTotal += val;
      
      const colColor = colors[i % colors.length];
      const hasVal = val > 0;
      const styleAttr = hasVal ? `style="background:${colColor}"` : ``;
      const highlightClass = hasVal ? "highlighted-cell" : "";
      
      row += `<td>
        <input type="number" min="0" step="1" 
               class="cell-input ${highlightClass}" 
               data-dept="${dept}" 
               data-staff="${i}" 
               data-color="${colColor}"
               value="${val}" 
               ${styleAttr}>
      </td>`;
    }
    
    row += `<td class="row-total-cell" data-dept="${dept}">${rowTotal}</td>`;
    row += "</tr>";
    tbody.innerHTML += row;
  });

  // 4. Totals Footer
  let rowTotalsRow = `<tr class="row-totals"><th>TOTAL</th>`;
  const rowTotals = calculateRowTotals();
  for (let i=0;i<staffCount;i++){
    rowTotalsRow += `<td>${rowTotals.staff[i] || 0}</td>`;
  }
  rowTotalsRow += `<td>${rowTotals.grandTotal || 0}</td></tr>`;
  tbody.innerHTML += rowTotalsRow;

  // Listeners
  document.querySelectorAll('.cell-input').forEach(inp=>{
    inp.addEventListener('input', onCellInput);
    inp.addEventListener('blur', ()=> {
      if (inp.value === "") inp.value = inp.value;
      updateTotalsFromTable();
    });
  });

  updateLockVisuals();
  updateTotalsFromTable();
}

/* ---------- calculate row totals ---------- */
function calculateRowTotals() {
  const staffTotals = new Array(staffCount).fill(0);
  const deptTotals = {ICU: 0, CT: 0, CD: 0, CCU: 0};
  let grandTotal = 0;

  if (currentData) {
    deptTotals.ICU = currentData.ICU.reduce((sum, val) => sum + val, 0);
    deptTotals.CT = currentData.CT.reduce((sum, val) => sum + val, 0);
    deptTotals.CD = currentData.CD.reduce((sum, val) => sum + val, 0);
    deptTotals.CCU = currentData.CCU.reduce((sum, val) => sum + val, 0);
    
    for (let i = 0; i < staffCount; i++) {
      staffTotals[i] = (currentData.ICU[i] || 0) + (currentData.CT[i] || 0) + 
                       (currentData.CD[i] || 0) + (currentData.CCU[i] || 0);
    }
    grandTotal = deptTotals.ICU + deptTotals.CT + deptTotals.CD + deptTotals.CCU;
  }
  return { dept: deptTotals, staff: staffTotals, grandTotal: grandTotal };
}

function updateRowTotalsDisplay() {
  const rowTotals = calculateRowTotals();
  document.querySelectorAll('.row-total-cell').forEach(cell => {
    const dept = cell.getAttribute('data-dept');
    cell.innerText = rowTotals.dept[dept] || 0;
  });
  
  const rowTotalsRow = document.querySelector('.row-totals');
  if (rowTotalsRow) {
    let cells = rowTotalsRow.querySelectorAll('td');
    for (let i = 0; i < staffCount; i++) {
      if (cells[i]) cells[i].innerText = rowTotals.staff[i] || 0;
    }
    if (cells[staffCount]) cells[staffCount].innerText = rowTotals.grandTotal || 0;
  }
}

function onCellInput(e){
  const el = e.target;
  let v = el.value.replace(/[^\d-]/g,'').replace(/-/g,'');
  el.value = v;
  
  if (v > 0) {
    el.classList.add('highlighted-cell');
    el.style.background = el.dataset.color;
  } else {
    el.classList.remove('highlighted-cell');
    el.style.background = '';
  }

  updateTotalsFromTable();
}

function updateTotalsFromTable(){
  for (let s=0;s<staffCount;s++){
    let sum = 0;
    ["ICU","CT","CD","CCU"].forEach(dept=>{
      const cellInput = document.querySelector(`.cell-input[data-staff="${s}"][data-dept="${dept}"]`);
      const v = cellInput ? toInt(cellInput.value) : 0;
      sum += v;
      if (currentData && currentData[dept]) currentData[dept][s] = v;
    });
    if (currentData && currentData.Total) currentData.Total[s] = sum;
  }
  updateRowTotalsDisplay();
}

function toggleLock(evt, el, index){
  locked[index] = !locked[index];
  const anyLocked = locked.some(v=>v);
  document.getElementById("recalcBtn").style.display = anyLocked ? "block" : "none";
  updateLockVisuals();
}

function updateLockVisuals(){
  // 1. Icons
  document.querySelectorAll('.lock-btn').forEach(btn => {
    const idx = parseInt(btn.getAttribute('data-index'));
    const use = btn.querySelector('use');
    if (locked[idx]) {
        btn.classList.add('locked');
        use.setAttribute('href', '#icon-lock');
    } else {
        btn.classList.remove('locked');
        use.setAttribute('href', '#icon-unlock');
    }
  });

  // 2. Dim headers
  const badges = document.querySelectorAll('.staff-badge');
  badges.forEach((b, idx) => {
      if(locked[idx]) {
          b.style.opacity = "0.5";
          b.style.filter = "grayscale(100%)";
      } else {
          b.style.opacity = "1";
          b.style.filter = "none";
      }
  });
  
  // 3. Style inputs
  document.querySelectorAll('.cell-input').forEach(inp => {
    const s = parseInt(inp.getAttribute('data-staff'));
    const td = inp.parentElement;
    
    if (locked[s]) {
      td.style.background = "repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.03) 5px, rgba(0,0,0,0.03) 10px)";
      inp.style.color = "var(--text-secondary)";
      inp.style.pointerEvents = "none"; 
      
      if (inp.value > 0) {
         inp.style.opacity = "0.6"; 
      } else {
         inp.style.opacity = "1";
      }
    } else {
      td.style.background = "transparent";
      inp.style.color = "var(--text-primary)";
      inp.style.pointerEvents = "auto";
      inp.style.opacity = "1";
    }
  });
}

function renderFinalOriginal(data){
  if(!data) return;
  setText("finalPrev", data.Total.map(n=>n||0).join(", "));
  setText("finalAfter", "");
}

/* ---------- recalculate unlocked only ---------- */
function recalculateUnlocked(){
  if (!currentData) return;
  const deptInput = {
    CCU: inputVal("ccuPatients"),
    CD:  inputVal("cdPatients"),
    CT:  inputVal("ctPatients"),
    ICU: inputVal("icuPatients")
  };
  
  const lockedContrib = {CCU:0, CD:0, CT:0, ICU:0};
  let lockedCount = 0;
  for (let s=0;s<staffCount;s++){
    if (!locked[s]) continue;
    lockedCount++;
    ["CCU","CD","CT","ICU"].forEach(dept=>{
      const inp = document.querySelector(`.cell-input[data-staff="${s}"][data-dept="${dept}"]`);
      const val = inp ? toInt(inp.value) : 0;
      lockedContrib[dept] += val;
    });
  }

  for (const d of ["CCU","CD","CT","ICU"]){
    if (lockedContrib[d] > deptInput[d]) {
      alert(`Locked staff claim ${lockedContrib[d]} in ${d}, which exceeds input ${deptInput[d]}. Adjust locked values first.`);
      return;
    }
  }

  const rem = {
    CCU: deptInput.CCU - lockedContrib.CCU,
    CD:  deptInput.CD  - lockedContrib.CD,
    CT:  deptInput.CT  - lockedContrib.CT,
    ICU: deptInput.ICU - lockedContrib.ICU
  };
  const totalRem = rem.CCU + rem.CD + rem.CT + rem.ICU;
  const unlockedCount = staffCount - lockedCount;
  if (unlockedCount <= 0) { alert("All staff are locked ‚Äî nothing to recalculate."); return; }

  const modResult = totalRem % unlockedCount;
  const higher = Math.ceil(totalRem / unlockedCount);
  const lower = Math.floor(totalRem / unlockedCount);

  const newCCU = currentData.CCU.slice();
  const newCD  = currentData.CD.slice();
  const newCT  = currentData.CT.slice();
  const newICU = currentData.ICU.slice();
  const newTotal = currentData.Total.slice();

  const unlockedStaff = [];
  for (let s=0;s<staffCount;s++){
    if (!locked[s]) unlockedStaff.push(s);
  }

  unlockedStaff.forEach(s => {
    newCCU[s] = 0; newCD[s] = 0; newCT[s] = 0; newICU[s] = 0; newTotal[s] = 0;
  });

  const remCopy = {...rem};
  
  for (let i=0;i<unlockedStaff.length;i++){
    const s = unlockedStaff[i];
    const workload = (i < modResult) ? higher : lower;
    
    const ccuAlloc = Math.min(remCopy.CCU, workload);
    remCopy.CCU -= ccuAlloc;

    const cdAlloc = Math.min(remCopy.CD, workload - ccuAlloc);
    remCopy.CD -= cdAlloc;

    const ctAlloc = Math.min(remCopy.CT, workload - ccuAlloc - cdAlloc);
    remCopy.CT -= ctAlloc;

    const icuAlloc = Math.min(remCopy.ICU, workload - ccuAlloc - cdAlloc - ctAlloc);
    remCopy.ICU -= icuAlloc;

    newCCU[s] = ccuAlloc;
    newCD[s]  = cdAlloc;
    newCT[s]  = ctAlloc;
    newICU[s] = icuAlloc;
    newTotal[s] = ccuAlloc + cdAlloc + ctAlloc + icuAlloc;
  }

  currentData = {CCU:newCCU, CD:newCD, CT:newCT, ICU:newICU, Total:newTotal};

  ["ICU","CT","CD","CCU"].forEach((dept) => {
    for (let s=0;s<staffCount;s++){
      const inp = document.querySelector(`.cell-input[data-staff="${s}"][data-dept="${dept}"]`);
      if (!inp) continue;
      if (!locked[s]) {
        inp.value = currentData[dept][s] !== undefined ? currentData[dept][s] : 0;
        if (inp.value > 0) {
            inp.classList.add('highlighted-cell');
            inp.style.background = inp.dataset.color;
        } else {
            inp.classList.remove('highlighted-cell');
            inp.style.background = '';
        }
      }
    }
  });

  updateTotalsFromTable();
  setText("finalAfter", "FINAL (After Lock): " + currentData.Total.map(n=>n||0).join(", "));
}

function resetAll(){
  document.getElementById("totalStaff").value = "";
  document.getElementById("icuPatients").value = "";
  document.getElementById("ctPatients").value = "";
  document.getElementById("cdPatients").value = "";
  document.getElementById("ccuPatients").value = "";
  setText("finalPrev","‚Äî");
  setText("finalAfter","");
  setText("totalPatientsDisplay","Total Patients: 0");
  document.getElementById("thead").innerHTML = "";
  document.getElementById("tbody").innerHTML = "";
  document.getElementById("resultsCard").style.display = "none";
  currentData = null; locked = []; staffCount = 0;
  document.getElementById("recalcBtn").style.display = "none";
}
</script>
</body>
</html>
